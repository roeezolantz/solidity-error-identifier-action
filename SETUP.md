# Setup Guide

## Publishing this GitHub Action

### 1. Create the Repository

```bash
cd /Users/roeezolantz/Development/solidity-error-identifier-action
git init
git add .
git commit -m "Initial commit: Solidity Error Identifier Action"
```

### 2. Push to GitHub

```bash
# Create repo on GitHub first: https://github.com/new
# Name it: solidity-error-identifier-action

git remote add origin git@github.com:FhenixProtocol/solidity-error-identifier-action.git
git branch -M main
git push -u origin main
```

### 3. Build the Action

Before creating a release, you must build the action:

```bash
npm install
npm run build
```

This creates `dist/index.js` which is what GitHub Actions actually runs.

**IMPORTANT**: Commit the `dist/` directory:

```bash
git add dist/
git commit -m "chore: build action"
git push
```

### 4. Create a Release

GitHub Actions are versioned using git tags and releases:

```bash
git tag -a v1.0.0 -m "Release v1.0.0"
git push origin v1.0.0
```

Then create a GitHub Release from this tag.

### 5. Create the `v1` Major Version Tag

For easier updates, create a moving tag:

```bash
git tag -fa v1 -m "Update v1 tag"
git push origin v1 --force
```

Users can now use `@v1` in their workflows and automatically get the latest v1.x.x version.

## Using the Action in cofhe-contracts

### Option 1: Direct Integration (Recommended)

In `cofhe-contracts/.github/workflows/update-errors.yml`:

```yaml
name: Update Error Database
on:
  push:
    branches:
      - master
    paths:
      - 'contracts/**/*.sol'

jobs:
  update-errors:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # ... compile your contracts ...

      # Use the action
      - uses: FhenixProtocol/solidity-error-identifier-action@v1
        with:
          abi-paths: 'artifacts/.temp-sources,contracts/internal/host-chain/artifacts/contracts'
          output-path: 'scripts/error-identifier/dist/errors.json'

      # Commit changes
      - name: Commit updated errors
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          if ! git diff --quiet scripts/error-identifier/dist/errors.json; then
            git add scripts/error-identifier/dist/errors.json
            git commit -m "chore: update error database"
            git push
          fi
```

### Option 2: Testing Locally Before Publishing

You can test the action locally in cofhe-contracts before publishing:

```yaml
- uses: /path/to/local/solidity-error-identifier-action
  with:
    abi-paths: 'artifacts/.temp-sources'
    output-path: 'errors.json'
```

## What cofhe-contracts Needs

### Minimal Changes to cofhe-contracts

1. **Keep**: `scripts/error-identifier/dist/errors.json` (generated by action)
2. **Keep**: `contracts/package.json` with:
   ```json
   {
     "bin": {
       "fhenix-error-identifier": "../scripts/error-identifier/dist/src/cli.js"
     },
     "files": [
       "FHE.sol",
       "ICofhe.sol",
       "../scripts/error-identifier/dist/"
     ]
   }
   ```
3. **Keep**: `scripts/error-identifier/` for CLI tool ONLY (not extraction logic)
4. **Add**: GitHub workflow using this action
5. **Remove**: All root-level config files (hardhat, tsconfig, etc.)

### CLI Tool in cofhe-contracts

The CLI tool (`scripts/error-identifier/src/cli.ts`) stays in cofhe-contracts for distribution with the npm package. It only needs:
- `cli.ts` - The CLI interface
- `errorDatabase.ts` - For loading and searching the database
- `utils.ts` - Formatting functions
- `dist/errors.json` - Generated by THIS action

The extraction logic (`errorExtractor.ts`, `errorSelector.ts`, compilation) moves to THIS repo.

## Repository Structure

```
solidity-error-identifier-action/
├── action.yml                 # Action definition
├── package.json               # Dependencies
├── tsconfig.json              # TypeScript config
├── src/
│   ├── index.ts              # Main action entry point
│   ├── errorExtractor.ts     # Extract errors from ABIs
│   ├── errorSelector.ts      # Compute error selectors
│   └── utils.ts              # Utility functions
├── dist/
│   └── index.js              # Compiled action (must be committed!)
├── examples/
│   └── cofhe-contracts-workflow.yml  # Example usage
└── README.md                 # Documentation
```

## Maintenance

### Updating the Action

1. Make changes to `src/`
2. Build: `npm run build`
3. Commit: `git add dist/ && git commit -m "feat: your change"`
4. Tag: `git tag -a v1.0.1 -m "Release v1.0.1"`
5. Push: `git push && git push --tags`
6. Update v1: `git tag -fa v1 && git push origin v1 --force`

### Benefits of This Approach

✅ **Clean Separation**: cofhe-contracts repo stays clean
✅ **Reusable**: Other projects can use this action
✅ **Maintainable**: Extraction logic has its own repo/versions
✅ **Black Box**: cofhe-contracts just uses it, doesn't need to understand it
✅ **No Dependencies**: cofhe-contracts doesn't need hardhat/ethers for error extraction
